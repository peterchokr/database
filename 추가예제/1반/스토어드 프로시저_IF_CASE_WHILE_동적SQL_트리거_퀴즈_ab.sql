-- =====================================================================
-- MySQL SQL 퀴즈: 스토어드 프로시저, IF, CASE, WHILE, 동적SQL, 트리거
-- =====================================================================
CREATE DATABASE IF NOT EXISTS quiz_db;
USE quiz_db;


-- 테이블 생성
CREATE TABLE users (user_id INT PRIMARY KEY AUTO_INCREMENT, user_name VARCHAR(50), email VARCHAR(100), join_date DATE);
CREATE TABLE categories (category_id INT PRIMARY KEY AUTO_INCREMENT, category_name VARCHAR(50));
CREATE TABLE products (product_id INT PRIMARY KEY AUTO_INCREMENT, product_name VARCHAR(100), category_id INT, price DECIMAL(10,2), stock INT);
CREATE TABLE orders (order_id INT PRIMARY KEY AUTO_INCREMENT, user_id INT, order_date DATE, total_amount DECIMAL(10,2));
CREATE TABLE order_items (order_item_id INT PRIMARY KEY AUTO_INCREMENT, order_id INT, product_id INT, quantity INT, price DECIMAL(10,2));

-- 데이터 입력
INSERT INTO users VALUES (1,'김철수','kim@email.com','2024-01-15'), (2,'이영희','lee@email.com','2024-02-20'), (3,'박민수','park@email.com','2024-03-10'), (4,'최지은','choi@email.com','2024-04-05'), (5,'정태양','jung@email.com','2024-05-12');
INSERT INTO categories VALUES (1,'전자제품'), (2,'의류'), (3,'식품'), (4,'도서'), (5,'스포츠');
INSERT INTO products VALUES (1,'무선 이어폰',1,89000,50), (2,'블루투스 스피커',1,120000,30), (3,'청바지',2,59000,100), (4,'티셔츠',2,25000,150), (5,'초콜릿 세트',3,35000,80), (6,'커피 원두',3,18000,60), (7,'프로그래밍 입문서',4,32000,40), (8,'소설책',4,15000,70), (9,'요가 매트',5,45000,35), (10,'덤벨 세트',5,95000,20);
INSERT INTO orders VALUES (1,1,'2024-06-01',178000), (2,2,'2024-06-03',84000), (3,1,'2024-06-05',120000), (4,3,'2024-06-07',77000), (5,4,'2024-06-10',140000), (6,2,'2024-06-12',32000), (7,5,'2024-06-15',95000);
INSERT INTO order_items VALUES (1,1,1,2,89000), (2,2,3,1,59000), (3,2,4,1,25000), (4,3,2,1,120000), (5,4,5,1,35000), (6,4,6,2,18000), (7,4,8,1,15000), (8,5,9,2,45000), (9,5,7,1,32000), (10,6,7,1,32000), (11,7,10,1,95000);

-- =====================================================================
-- 1. 스토어드 프로시저 (STORED PROCEDURE)
-- =====================================================================

-- 1. (초급)
-- 문제: 사용자 ID를 매개변수로 받아서, 해당 사용자가 주문한 모든 주문의 ID와 주문 금액을 반환하는 
-- 스토어드 프로시저 GetUserOrders를 작성하시오.
-- 예: 사용자 ID 1번(김철수)을 입력하면 주문 ID 1번(178000원)과 3번(120000원)이 조회되어야 한다.

-


-- 2. (중급)
-- 문제: 카테고리 ID를 매개변수로 받아서, 해당 카테고리에 속한 모든 상품의 판매 기록을 조회하는 
-- 스토어드 프로시저 GetCategorySales를 작성하시오.
-- 이 프로시저는 상품명, 판매 수량, 판매 단가, 소계(수량×단가)를 보여줘야 한다.
-- 예: 카테고리 1번(전자제품)을 입력하면 무선 이어폰과 블루투스 스피커의 판매 정보가 나와야 한다.




-- =====================================================================
-- 2. IF 문 (IF STATEMENT)
-- =====================================================================

-- 3. (초급)
-- 문제: 상품의 가격을 입력받아서 다음과 같이 상품 등급을 판정하는 
-- 스토어드 프로시저 GetPriceGrade를 작성하시오.
-- - 100,000원 이상: '프리미엄'
-- - 50,000원 이상 100,000원 미만: '스탠다드'
-- - 50,000원 미만: '이코노미'
-- 결과를 문자열로 반환하시오.
-- 예: 89,000원을 입력하면 '스탠다드', 120,000원을 입력하면 '프리미엄'이 반환되어야 한다.




-- 4. (중급)
-- 문제: 상품 ID를 입력받아서, 재고 상태에 따라 다른 결과를 출력하는 
-- 스토어드 프로시저 CheckStockStatus를 작성하시오.
-- - 재고가 50개 이상: '충분' 상태
-- - 재고가 20개 이상 50개 미만: '보통' 상태
-- - 재고가 20개 미만: '부족' 상태
-- 상품명과 함께 재고 상태를 반환하시오.
-- 예: 상품 ID 1번(무선 이어폰, 재고 50개)을 입력하면 상품명과 '충분' 상태가 함께 반환되어야 한다.




-- =====================================================================
-- 3. CASE 문 (CASE STATEMENT)
-- =====================================================================

-- 5. (초급)
-- 문제: 주문 금액을 기준으로 배송료를 계산하는 스토어드 프로시저 CalculateShippingFee를 작성하시오.
-- 배송료 규칙:
-- - 100,000원 이상: 배송료 0원 (무료)
-- - 50,000원 이상 100,000원 미만: 배송료 5,000원
-- - 50,000원 미만: 배송료 10,000원
-- 주문 금액과 함께 배송료를 반환하시오.
-- 예: 120,000원의 주문이면 배송료 0원, 89,000원의 주문이면 배송료 5,000원이 반환되어야 한다.



-- 6. (중급)
-- 문제: 주문 정보를 조회할 때, CASE를 사용하여 주문 상태를 판정하는 
-- 스토어드 프로시저 GetOrderStatusReport를 작성하시오.
-- 주문 금액을 기준으로 상태를 판정:
-- - 150,000원 이상: '대형 주문'
-- - 100,000원 이상 150,000원 미만: '중형 주문'
-- - 50,000원 이상 100,000원 미만: '소형 주문'
-- - 50,000원 미만: '미니 주문'
-- 모든 주문에 대해 주문 ID, 주문자명, 주문 금액, 주문 상태를 조회하시오.



-- =====================================================================
-- 4. WHILE 루프 (WHILE LOOP)
-- =====================================================================

-- 7. (초급)
-- 문제: WHILE 루프를 사용하여 1부터 10까지의 수를 더하는 
-- 스토어드 프로시저 SumNumbers를 작성하시오.
-- 최종 합계를 반환하시오.
-- 예: 결과는 55(1+2+3+...+10)가 반환되어야 한다.






-- =====================================================================
-- 5. 동적 SQL (DYNAMIC SQL)
-- =====================================================================

-- 8. (초급)
-- 문제: 테이블명을 매개변수로 받아서 PREPARE와 EXECUTE를 사용하여 
-- 해당 테이블의 모든 레코드를 조회하는 스토어드 프로시저 GetTableData를 작성하시오.
-- 예: 'products' 테이블을 입력하면 모든 상품 정보가 조회되어야 한다.




-- 9. (중급)
-- 문제: 동적 SQL을 사용하여 사용자가 지정한 조건으로 상품을 검색하는 
-- 스토어드 프로시저 SearchProducts를 작성하시오.
-- 매개변수: 최소 가격(p_min_price), 최대 가격(p_max_price)
-- 주어진 가격 범위 내의 모든 상품을 상품명, 가격, 재고와 함께 반환하시오.
-- 예: 최소 30,000원, 최대 100,000원의 범위를 입력하면 이 범위의 상품들이 조회되어야 한다.




-- =====================================================================
-- 6. 트리거 (TRIGGER)
-- =====================================================================

-- 10. (초급)
-- 문제: 주문 항목(order_items)이 삭제될 때 자동으로 해당 상품의 재고를 복구하는 
-- AFTER DELETE 트리거를 작성하시오.
-- 트리거명: trg_restore_stock_on_delete
-- 예: 주문 항목에서 상품 1번 수량 2개 주문 기록이 삭제되면, 
-- 자동으로 상품 1번의 재고가 2개 증가해야 한다.




-- 11. (중급)
-- 문제: 주문(orders) 테이블에 변경 로그를 기록하기 위해 다음과 같은 작업을 수행하는 
-- AFTER UPDATE 트리거를 작성하시오.
-- 1. order_logs라는 새로운 테이블을 미리 생성한다. (구조: log_id, order_id, old_amount, new_amount, change_date)
-- 2. 주문 금액이 업데이트될 때마다 이전 금액과 새로운 금액을 로그 테이블에 기록한다.
-- 트리거명: trg_log_order_update


